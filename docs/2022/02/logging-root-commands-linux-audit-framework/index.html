<!doctype html><html lang="en"><head><title>Logging root commands on Linux using Linux Audit Framework</title><meta charset="utf-8"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="generator" content="Eduard Roccatello"><meta name="generator" content="Hugo 0.150.0"><meta name="author" content="Eduard Roccatello"><meta name="description" content="Sometimes, for law compliance or internal security policy, you may need to log everything a system administrator does on a Linux box. Here is how."><meta property="og:title" content="Logging root commands on Linux using Linux Audit Framework"><meta property="og:site_name" content="Eduard Roccatello's GIS blog"><meta property="og:url" content="https://www.roccatello.it/2022/02/logging-root-commands-linux-audit-framework/"><meta property="og:description" content="Sometimes, for law compliance or internal security policy, you may need to log everything a system administrator does on a Linux box. Here is how."><meta property="og:type" content="article"><meta property="og:image" content="https://www.roccatello.it/img/placeholder.jpg"><link href="/init.ee2bdbeda8ae4e5525c6.css" rel="stylesheet"><script src="/init.346aa.js"></script></head><body><nav class="navbar navbar-dark fixed-top bg-dark navbar-expand-lg" id="navbar-main"><div class="container"><a class="navbar-brand" href="/">Eduard Roccatello's GIS blog</a>
<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
<span class="navbar-toggler-icon"></span></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ms-auto"><li class="nav-item"><a class="nav-link" href="/#mondogis"><span>Tales from the GIS</span></a></li><li class="nav-item"><a class="nav-link" href="/post"><span>Articles</span></a></li><li class="nav-item"><a class="nav-link" href="/#showcase"><span>Showcase</span></a></li><li class="nav-item"><a class="nav-link" href="/#aboutme"><span>About</span></a></li><li class="nav-item"><a class="nav-link" href="/#contacts"><span>Contacts</span></a></li></ul></div></div></nav><article class="article" itemscope itemtype="http://schema.org/Article"><div class="p-3 bg-success text-light mb-0"><div class="container"><div class="row"><div class="col col-lg-8 offset-lg-2"><h2>Logging root commands on Linux using Linux Audit Framework</h2><p class="lead">Sometimes, for law compliance or internal security policy, you may need to log everything a system administrator does on a Linux box. Here is how.</p></div></div></div></div><div class="bg-secondary"><div class="container text-light"><div class="d-flex justify-content-between align-items-center pt-3 pb-3 col col-lg-8 offset-lg-2"><div class="article-metadata"><span itemscope itemprop="author" itemtype="http://schema.org/Person"><meta itemprop="name" content="Eduard Roccatello"></span><span class="article-date"><meta content="2022-02-11 00:00:00 +0000 UTC" itemprop="datePublished"><time datetime="2022-02-11 00:00:00 +0000 UTC" itemprop="dateModified"><i class="fa fa-calendar fa-fw mr-1"></i>2022-02-11
</time></span><span itemscope itemprop="publisher" itemtype="http://schema.org/Person"><meta itemprop="name" content="Eduard Roccatello"></span><span class="middot-divider"></span>
<span class="article-reading-time"><i class="fa fa-clock fa-fw mr-1"></i>2 min read</span></div><div class="share-box" aria-hidden="true"><ul class="share list-inline m-0"><li class="list-inline-item"><a class="facebook text-light" href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.roccatello.it%2f2022%2f02%2flogging-root-commands-linux-audit-framework%2f" target="_blank" rel="noopener"><i class="fab fa-fw fa-facebook-f"></i></a></li><li class="list-inline-item"><a class="linkedin text-light" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.roccatello.it%2f2022%2f02%2flogging-root-commands-linux-audit-framework%2f&amp;title=Logging%20root%20commands%20on%20Linux%20using%20Linux%20Audit%20Framework" target="_blank" rel="noopener"><i class="fab fa-fw fa-linkedin-in"></i></a></li><li class="list-inline-item"><a class="email text-light" href="mailto:?subject=Logging%20root%20commands%20on%20Linux%20using%20Linux%20Audit%20Framework&amp;body=https%3a%2f%2fwww.roccatello.it%2f2022%2f02%2flogging-root-commands-linux-audit-framework%2f"><i class="fas fa-fw fa-envelope"></i></a></li></ul></div></div></div></div><div class="container"><div class="article-style row pt-4" itemprop="articleBody"><div class="col col-lg-8 offset-lg-2"><p>I want to enforce my security policies, so my desiderata is to log everything a root use does on a Linux server.
Linux kernel contains a feature called Linux Audit Framework, which is obviously a framework to allow auditing events on a system.</p><p>It seems like it could serve our purpose. Let&rsquo;s dig in.</p><h2 id="enable-linux-audit-framework">Enable Linux Audit Framework</h2><p>Linux Audit Framework is already enabled in recent kernels, so your Linux distro should already be compatible.
You just need to ensure you have <strong>auditd</strong> installed and running.
Auditd is the responsible for audit data collection, which is stored in /var/log/auditd.log.</p><p>In Ubuntu, you can install it using the following command, which also installs related useful tools:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>sudo apt install auditd
</span></span></code></pre></div><p>The main tools you will need are: <strong>auditctl</strong> (the auditd client) and <strong>ausearch</strong> (the event viewer client).</p><p>The framework also includes the following tools: audispd, aureport, autrace, aulast, aulastlog, ausyscall, auvirt.</p><h2 id="enable-root-execve-syscall-logging">Enable root execve syscall logging</h2><p>Our main objective is to monitor the execve syscall, whenever the effective UID (user ID) is 0 (root).
This allows us to log both root shells and sudo commands.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>auditctl -a exit,always -F euid<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> -F arch<span style="color:#f92672">=</span>b64 -S execve -k root-exevce
</span></span><span style="display:flex"><span>auditctl -a exit,always -F euid<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> -F arch<span style="color:#f92672">=</span>b32 -S execve -k root-exevce
</span></span></code></pre></div><p>These commands will:</p><ul><li>set a rule which applies at the exit of the syscall, with always policy</li><li>filter for effective UID equal to 0</li><li>filter for binary architecture (one row for 64 bit syscalls, one for 32 bit syscalls)</li><li>filter for syscall execve</li><li>tag events as root-commands</li></ul><h2 id="enable-stricter-root-actions-logging">Enable stricter root actions logging</h2><p>If we want to enforce logging to all actions involving root, we could use a permission-based filter as follows:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>auditctl -a exit,always -F euid<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> -F perm<span style="color:#f92672">=</span>awx -S all -k root-actions
</span></span></code></pre></div><p>The logic is the same above, but we enable a filter on <strong>permissions</strong> and enable a wildcard on the syscalls.
In this case, we are logging:</p><ul><li>command executions</li><li>file writing</li><li>file attribute changes</li></ul><blockquote><p>Take a look to <strong>man auditctl</strong> to discover all Linux Audit Framework capabilities.</p></blockquote><h2 id="list-rules">List rules</h2><p>You can list rules using:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>auditctl -l
</span></span></code></pre></div><h2 id="delete-a-rule-or-all-rules">Delete a rule or all rules</h2><p>You can delete a rule using <strong>-d</strong> instead of <strong>-a</strong>, followed by the full input of the rule.</p><p>You can also clear rules with:</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>auditctl -D
</span></span></code></pre></div><h2 id="using-the-event-viewer-ausearch">Using the event viewer: ausearch</h2><p>If you are looking for an event, you can use <strong>ausearch</strong>.</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="display:flex"><span>ausearch -k TAG_NAME
</span></span></code></pre></div><p>TAG_NAME is root-execve or root-actions, as we defined before.</p><p><strong>ausearch</strong> command is quite complex, so take a look to its man page.</p></div></div></div></article><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"><link href="/main.ceec15bd736a22810641.css" rel="stylesheet"><footer class="bg-success text-light"><div class="container"><div class="row p-2"><div class="col"><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="link-light">CC BY-SA 4.0 by Eduard Roccatello</a></div><div class="col text-end"><a href="/privacy" class="link-light">Privacy policy</a></div></div></div></footer><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous"><link href="/main.ceec15bd736a22810641.css" rel="stylesheet"><script src="/main.346aa.js"></script></body></html>