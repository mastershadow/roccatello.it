{{ $ := .root }}
{{ $page := .page }}
{{ $pubs_len := len (where $.Site.RegularPages "Type" "publication") }}

<section id="publications">
  <div class="container">
    <!-- Publications widget -->
    <div class="row">
      <div class="col-12 col-lg-4 section-heading">
        <h1>{{ with $page.Title }}{{ . | markdownify }}{{ end }}</h1>
        {{ with $page.Params.subtitle }}<p>{{ . | markdownify }}</p>{{ end }}
        {{ if gt $pubs_len $page.Params.count }}
        <p class="view-all">
          <a href="{{ ($.Site.GetPage "section" "publication").RelPermalink }}">
            {{ i18n "more_publications" | markdownify }}
            <i class="fas fa-angle-double-right"></i>
          </a>
        </p>
        {{ end }}
      </div>
      <div class="col-12 col-lg-8">
        {{ with $page.Content }}<p>{{ . | markdownify }}</p>{{ end }}

        {{ if and ($page.Params.publication_type) (ne $page.Params.publication_type "-1") }}
        {{ $.Scratch.Set "recent_pubs" (where (where $.Site.RegularPages "Type" "publication") ".Params.publication_types" "intersect" (slice $page.Params.publication_type)) }}
        {{ else }}
        {{ $.Scratch.Set "recent_pubs" (where $.Site.RegularPages "Type" "publication") }}
        {{ end }}

        {{ if $page.Params.exclude_selected }}
        {{ $.Scratch.Set "recent_pubs" ( ($.Scratch.Get "recent_pubs") | intersect (where (where $.Site.RegularPages "Type" "publication") ".Params.selected" "!=" true) ) }}
        {{ end }}

        {{ $recent_pubs := $.Scratch.Get "recent_pubs" }}
        {{ range first $page.Params.count $recent_pubs }}
        <div class="pub-list-item" style="margin-bottom: 1rem" itemscope itemtype="http://schema.org/CreativeWork">
          <i class="far fa-file-alt pub-icon" aria-hidden="true"></i>
          <span itemprop="author">
            {{ with .Params.authors }}
            {{- delimit . ", " | markdownify -}}
            {{- end -}}
          </span>
          ({{- .Date.Format "2006" -}}).
          <a href="{{ .RelPermalink }}" itemprop="name">{{ .Title }}</a>.
          {{ if .Params.publication_short }}
          {{- .Params.publication_short | markdownify -}}.
          {{ else if .Params.publication }}
          {{- .Params.publication | markdownify -}}.
          {{ end }}
          <p>{{ partial "publication_links" (dict "content" . "is_list" 1) }}</p>
        </div>
        {{ end }}

      </div>
    </div>

  </div>
</section>
